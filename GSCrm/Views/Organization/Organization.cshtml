@{
    Layout = "_Layout";
}
@using static GSCrm.CommonConsts
@using GSCrm.Data.ApplicationInfo
@using GSCrm.Helpers
@using GSCrm.Data
@using GSCrm.Data.Cash
@inject ApplicationDbContext context
@inject ResManager resManager
@inject ICachService cachService
@model OrganizationViewModel
@{
    User currentUser = User.GetUserModel(context);
    ViewInfo orgView = cachService.GetViewInfo(currentUser.Id, ORGANIZATIONS);
}

@* // Хлебные крошки *@
<nav aria-label="breadcrumb">
    <ol class="breadcrumb wide-crumbs">
        <li class="breadcrumb-item wide-crumb"><a asp-controller="Home" asp-action="Index">@resManager.GetString("Home")</a></li>
        <li class="breadcrumb-item wide-crumb">
            <a asp-controller="Root" asp-action="@ORGANIZATIONS" asp-route-pageNumber="@orgView.CurrentPageNumber">
                @resManager.GetString(ORGANIZATIONS)
            </a>
        </li>
        <li class="breadcrumb-item wide-crumb active" aria-current="page">@resManager.GetString(ORGANIZATION): @Model.Name</li>
    </ol>
</nav>

<div id="organizationForm" class="container mt-3">
    @if (Model.Accepted)
    {
        @* // Модальное окно создания подразделения *@
        await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/DivisionModal.cshtml");

        @* // Модальное окно создания должности *@
        await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/PositionModal.cshtml");

        @* // Модальное окно создания работника *@
        await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/EmployeeModal.cshtml");

        @* // Модальное окно управления полномочиями *@
        await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/ResponsibilitiesManagmentModal.cshtml");

        @* // Удаление организации *@
        <div id="orgFormActions" class="row justify-content-around">
            <div class="col nav-connected-tabs text-center mb-3 mb-md-0" nav-tabs="orgTabs">
                <div class="fade show nav-connected-tab" nav-tab="#divisions">
                    <input type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#divisionModal" value="@resManager.GetString("CreateDivisionLabel")" />
                </div>
                <div class="fade nav-connected-tab" nav-tab="#positions">
                    <input type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#positionModal" value="@resManager.GetString("CreatePositionLabel")" />
                </div>
                <div class="fade nav-connected-tab" nav-tab="#employees">
                    <input id="openEmployeeModalBtn" type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#employeeModal" value="@resManager.GetString("CreateEmployeeLabel")" />
                </div>
            </div>
            <div id="respsOrgForm" class="col text-center mb-3 mb-md-0">
                <button class="btn btn-outline-primary" data-toggle="modal" data-target="#responsibilitiesManagmentModal">@resManager.GetString("ResponsibilitiesManagment")</button>
            </div>
            @if (currentUser.Id == Model.OwnerId)
            {
                <div id="removeOrgForm" class="col text-center mb-3 mb-md-0">
                    <input id="orgId" hidden="hidden" asp-for="Id" />
                    <div id="orgUrl" hidden="hidden">@Html.ActionLink(Model.Id.ToString(), "Delete", ORGANIZATION, new { id = Model.Id })"</div>
                    <input id="removeOrgBtn" type="button" class="btn btn-outline-danger" value="@resManager.GetString("RemoveOrganizationLabel")" />
                </div>
            }
            else
            {
                <div id="leaveOrgForm" class="col text-center mb-3 mb-md-0">
                    <input id="orgId" hidden="hidden" asp-for="Id" />
                    <div id="orgUrl" hidden="hidden">@Html.ActionLink(Model.Id.ToString(), "Leave", ORGANIZATION, new { id = Model.Id })"</div>
                    <input id="leaveOrgBtn" type="button" class="btn btn-outline-danger" value="@resManager.GetString("LeaveOrganizationLabel")" />
                </div>
            }
        </div>
        <div id="orgFormHeader" class="row justify-content-center mt-3">
            <div class="col-auto">
                <div class="block-center">
                    <span class="icon-dots-three-vertical"></span>
                </div>
            </div>
            <div class="col">
                <h3 class="label-non-select text-center m-0">@Model.Name</h3>
            </div>
            <div id="orgSettingsBtn" data-settings-menu-id="orgSettingsMenu" class="settings-menu-btn col-auto">
                <div class="block-center">
                    <span class="icon-dots-three-vertical"></span>
                </div>
            </div>
        </div>
        <div class="mt-4">
            @* // Вкладки *@
            <ul id="orgTabs" class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link" id="division-tab" data-toggle="tab" href="#divisions" role="tab" aria-controls="divisions" aria-selected="false">@resManager.GetString(DIVISIONS)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="position-tab" data-toggle="tab" href="#positions" role="tab" aria-controls="positions" aria-selected="false">@resManager.GetString(POSITIONS)</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="employee-tab" data-toggle="tab" href="#employees" role="tab" aria-controls="employees" aria-selected="false">@resManager.GetString(EMPLOYEES)</a>
                </li>
            </ul>
            <div class="tab-content">
                @* // Подразделения *@
                @{ await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/DivisionsList.cshtml"); }

                @* // Должности *@
                @{ await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/PositionsList.cshtml"); }

                @* // Работники *@
                @{ await Html.RenderPartialAsync($"{ORG_VIEWS_REL_PATH}Partial/EmployeesList.cshtml"); }
            </div>
        </div>
        <div id="orgSettingsMenu" class="settings-menu d-none">
            <ul>
                <li>
                    <form action="@Url.Content($"/{ORGANIZATION}/{Model.Id}/{PROD_CATS}")">
                        <input id="goToProductModel" type="submit" class="label-sm" value="@resManager.GetString("ProductModel")" />
                    </form>
                </li>
            </ul>
        </div>
    }
    else
    {
        <div>
            <input id="orgId" hidden="hidden" asp-for="Id" />
            <div class="row justify-content-center mt-3">
                <h3 class="label-non-select text-center m-0">@Model.Name</h3>
            </div>
            <div class="row justify-content-center mt-3">
                <p class="label-md label-non-select text-center m-0">@resManager.GetString("YouHasBeenInvited")</p>
            </div>
            <div id="inviteActionsForm" class="row mt-4">
                <form class="col text-center" action="@Url.Content($"/{ORGANIZATION}/{Model.Id}/AcceptInvite/")">
                    <input id="acceptInvite" type="submit" class="btn btn-outline-dark" value="@resManager.GetString("AcceptInvite")" />
                </form>
                <form class="col mt-3 mt-sm-0 text-center" action="@Url.Content($"/{ORGANIZATION}/{Model.Id}/RejectInvite/")">
                    <input id="rejectInvite" type="submit" class="btn btn-outline-danger" value="@resManager.GetString("RejectInvite")" />
                </form>
            </div>
        </div>
    }
</div>